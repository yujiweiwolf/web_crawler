#!/usr/bin/python3
import requests
from bs4 import BeautifulSoup
import pdfplumber
import chardet
import pandas as pd
import os
import sys

os.system('clear')

# 打印所有命令行参数
for arg in sys.argv:
    print(arg)

file_name = 'downloaded_pdf.pdf'
csv_name = '网下初步配售结果及网上中签结果公告.csv'
fo = open(csv_name, "w+")   
 
# 访问特定参数，例如第二个参数
if len(sys.argv) > 1:
    print("第二个参数是:", sys.argv[1])
    url = sys.argv[1]
    response = requests.get(url)

    if response.status_code == 200:
        print("请求成功！")

        with open('downloaded_pdf.pdf', 'wb') as f:
            f.write(response.content)
            f.close()

        pdf =  pdfplumber.open(file_name)
        num_pages = len(pdf.pages)
        print(f"Number of pages: {num_pages}")
        title_flag = False
        page = pdf.pages[0]
        text = page.extract_text()
        # print(text[0])
        position = text.find("特别提示")
        if position != -1:
            fo.write(text[0:position])



        for page in pdf.pages:
            # first_page = pdf.pages[9]
            # 自动读取表格信息，返回列表
            table = page.extract_table()
            # print(f"Number of tables: {len(table)}")
            if table:
                flag = False
                index = 0
                for row in table:
                    index = index + 1
                    if (index == 1) :
                        if ((len(row) == 10) & (str(row[1]) == "投资者名称")& (str(row[2]) == "配售对象名称")) :
                            flag = True
                            print ("第一行的长度 %d" % len(row))
                            if (title_flag == False) :
                                result = ', '.join(row)
                                fo.write(str(result).replace(" ", "").replace("\n", ""))
                                fo.write("\n")
                                title_flag = True
                    else :
                        if (flag & (row[len(row) - 1] == "A")) :
                            # print(row)
                            result = ', '.join(row)
                            fo.write(str(result).replace(" ", "").replace("\n", ""))
                            fo.write("\n")
                        if (len(row) != 10):
                            flag = False;   

        fo.close()






